package handlers

import (
	"fmt"
	"strconv"
	"strings"
	

	"Lovifyy_bot/internal/exercises"
	"Lovifyy_bot/internal/models"
	"Lovifyy_bot/internal/services"

	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
)

// CommandHandler ???????????? ??????? ????
type CommandHandler struct {
	bot                 *tgbotapi.BotAPI
	userManager         *models.UserManager
	exerciseManager     *exercises.Manager
	notificationService *services.NotificationService
}

// NewCommandHandler ??????? ????? ?????????? ??????
func NewCommandHandler(bot *tgbotapi.BotAPI, userManager *models.UserManager, exerciseManager *exercises.Manager, notificationService *services.NotificationService) *CommandHandler {
	return &CommandHandler{
		bot:                 bot,
		userManager:         userManager,
		exerciseManager:     exerciseManager,
		notificationService: notificationService,
	}
}


// HandleStart ???????????? ??????? /start
func (ch *CommandHandler) HandleStart(update tgbotapi.Update) error {
	userID := update.Message.From.ID
	ch.userManager.ClearState(userID)
	
	welcomeText := `?? <b>?????????????? ????????? ??? ???</b>

??????, ???????! ???? ? ??? ??? ?????? ??? ????? ? ?????? ??????????? ? ??? ????????? ??????????? ?? ????? ??????????! ??

???? ??? ?????? ??? ????, ????? ?????? ???? ???????? ??????? ???????, ????? ? ???????????????, ???????? ???? ????? ? ?????? ?????? ???? ????????? ??? ????? ???????????.`

	keyboard := tgbotapi.NewInlineKeyboardMarkup(
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("?? ?????? ?????? ? ??????????", "mode_chat"),
		),
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("???????????? ?????????? ??????", "exercises"),
			tgbotapi.NewInlineKeyboardButtonData("?? ????-???????", "mode_diary"),
		),
	)

	if ch.userManager.IsAdmin(userID) {
		adminRow := tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("?? ?????-??????", "admin_panel"),
		)
		keyboard.InlineKeyboard = append(keyboard.InlineKeyboard, adminRow)
	}

	msg := tgbotapi.NewMessage(userID, welcomeText)
	msg.ParseMode = "HTML"
	msg.ReplyMarkup = keyboard
	_, err := ch.bot.Send(msg)
	return err
}


// HandleHelp ???????????? ??????? /help
func (ch *CommandHandler) HandleHelp(update tgbotapi.Update) error {
	userID := update.Message.From.ID
	text := "? ??????? ?? ????"
	msg := tgbotapi.NewMessage(userID, text)
	_, err := ch.bot.Send(msg)
	return err
}

// HandleMenu ???????????? ??????? /menu
func (ch *CommandHandler) HandleMenu(update tgbotapi.Update) error {
	return ch.HandleStart(update)
}

// HandleAdmin ???????????? ??????? /admin
func (ch *CommandHandler) HandleAdmin(update tgbotapi.Update) error {
	userID := update.Message.From.ID
	if !ch.userManager.IsAdmin(userID) {
		msg := tgbotapi.NewMessage(userID, "? ?????? ????????")
		_, err := ch.bot.Send(msg)
		return err
	}
	return ch.showAdminPanelLegacy(userID)
}

// HandleNotify ???????????? ??????? /notify
func (ch *CommandHandler) HandleNotify(update tgbotapi.Update) error {
	userID := update.Message.From.ID
	if !ch.userManager.IsAdmin(userID) {
		msg := tgbotapi.NewMessage(userID, "? ?????? ????????")
		_, err := ch.bot.Send(msg)
		return err
	}
	return ch.showNotificationPanel(userID)
}

// HandleAdminHelp ???????????? ??????? /adminhelp
func (ch *CommandHandler) HandleAdminHelp(update tgbotapi.Update) error {
	return ch.HandleAdmin(update)
}


// HandleCallback ???????????? ????????? callback queries
func (ch *CommandHandler) HandleCallback(update tgbotapi.Update) error {
	userID := update.CallbackQuery.From.ID
	data := update.CallbackQuery.Data
	
	switch data {
	case "mode_chat":
		ch.userManager.SetState(userID, "chat")
		msg := tgbotapi.NewMessage(userID, "?? **????? ???? ???????????**\n\n????????? ??? ?????? ? ????? ??????????!")
		msg.ParseMode = "Markdown"
		_, err := ch.bot.Send(msg)
		return err
	case "mode_diary":
		return ch.showDiaryGenderSelection(userID)
	case "main_menu":
		return ch.HandleStart(tgbotapi.Update{Message: &tgbotapi.Message{Chat: &tgbotapi.Chat{ID: userID}, From: &tgbotapi.User{ID: userID}}})
	case "exercises":
		return ch.showExercisesList(userID)
	case "admin_notifications":
		return ch.showNotificationPanel(userID)
	case "admin_weeks":
		return ch.showExercisesMenu(userID)
	case "notify_diary":
		return ch.showNotificationTypeActions(userID, string(models.NotificationDiary))
	case "notify_exercise":
		return ch.showNotificationTypeActions(userID, string(models.NotificationExercise))
	case "notify_motivation":
		return ch.showNotificationTypeActions(userID, string(models.NotificationMotivation))
	case "notify_view":
		return ch.showScheduledNotifications(userID)
	default:
		// Handle legacy admin callbacks
		if handled := ch.handleLegacyAdminCallbacks(userID, data); handled != nil {
			return handled
		}
		// Handle notification callbacks
		if handled := ch.handleNotificationCallbacks(userID, data); handled != nil {
			return handled
		}
		// Handle week callbacks
		if strings.HasPrefix(data, "week_") {
			return ch.handleWeekCallback(userID, data)
		}
		msg := tgbotapi.NewMessage(userID, "? ??????????? ????????")
		_, err := ch.bot.Send(msg)
		return err
	}
}

// HandleAdminPanel ???????????? callback admin_panel
func (ch *CommandHandler) HandleAdminPanel(update tgbotapi.Update) error {
	userID := update.CallbackQuery.From.ID
	if !ch.userManager.IsAdmin(userID) {
		msg := tgbotapi.NewMessage(userID, "? ?????? ????????")
		_, err := ch.bot.Send(msg)
		return err
	}
	return ch.showAdminPanelLegacy(userID)
}


// showExercisesList ?????????? ?????? ????????? ??????????
func (ch *CommandHandler) showExercisesList(userID int64) error {
	activeWeeks := ch.exerciseManager.GetActiveWeeks()
	
	if len(activeWeeks) == 0 {
		msg := tgbotapi.NewMessage(userID, "?? ???? ??? ????????? ??????????.\n\n?????????? ? ?????????????? ??? ????????? ??????.")
		_, err := ch.bot.Send(msg)
		return err
	}
	
	text := "??? ???????? ????????? ??????:"
	var rows [][]tgbotapi.InlineKeyboardButton
	
	for _, week := range activeWeeks {
		weekEmojis := []string{"1??", "2??", "3??", "4??", "5??", "6??", "7??", "8??", "9??", "??"}
		label := fmt.Sprintf("?????? %d", week)
		if week >= 1 && week <= len(weekEmojis) {
			label = fmt.Sprintf("%s ??????", weekEmojis[week-1])
		}
		buttonData := fmt.Sprintf("week_%d", week)
		
		rows = append(rows, tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData(label, buttonData),
		))
	}
	
	rows = append(rows, tgbotapi.NewInlineKeyboardRow(
		tgbotapi.NewInlineKeyboardButtonData("?? ?????", "main_menu"),
	))
	
	keyboard := tgbotapi.NewInlineKeyboardMarkup(rows...)
	msg := tgbotapi.NewMessage(userID, text)
	msg.ReplyMarkup = keyboard
	_, err := ch.bot.Send(msg)
	return err
}

// handleWeekCallback ???????????? ????? ?????? ??????????
func (ch *CommandHandler) handleWeekCallback(userID int64, data string) error {
	parts := strings.Split(data, "_")
	if len(parts) < 2 {
		return fmt.Errorf("invalid week callback data: %s", data)
	}
	
	weekStr := parts[1]
	weekNum, err := strconv.Atoi(weekStr)
	if err != nil {
		return fmt.Errorf("invalid week number: %s", weekStr)
	}
	
	exercise, err := ch.exerciseManager.GetWeekExercise(weekNum)
	if err != nil {
		msg := tgbotapi.NewMessage(userID, "? ?? ??????? ????????? ?????????? ??? ???? ??????.")
		_, err := ch.bot.Send(msg)
		return err
	}
	if exercise == nil {
		msg := tgbotapi.NewMessage(userID, "??? ?????????? ??? ???? ?????? ???? ?? ????????? ???????????????.")
		_, err := ch.bot.Send(msg)
		return err
	}

	title := strings.TrimSpace(exercise.Title)
	if title == "" {
		title = fmt.Sprintf("?????? %d", weekNum)
	}
	welcome := strings.TrimSpace(exercise.WelcomeMessage)
	var text string
	if welcome != "" {
		text = fmt.Sprintf("%s\n\n%s", title, welcome)
	} else {
		text = title
	}
	
	keyboard := tgbotapi.NewInlineKeyboardMarkup(
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("???????? ??????????", fmt.Sprintf("week_%d_questions", weekNum)),
			tgbotapi.NewInlineKeyboardButtonData("?? ?????????", fmt.Sprintf("week_%d_tips", weekNum)),
		),
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("?? ??????", fmt.Sprintf("week_%d_insights", weekNum)),
			tgbotapi.NewInlineKeyboardButtonData("?? ?????????? ???????", fmt.Sprintf("week_%d_joint", weekNum)),
		),
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("?? ??? ?????? ? ????????", fmt.Sprintf("week_%d_diary", weekNum)),
		),
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("?? ? ?????? ??????", "exercises"),
		),
	)
	
	msg := tgbotapi.NewMessage(userID, text)
	msg.ReplyMarkup = keyboard
	_, err = ch.bot.Send(msg)
	return err
}


// showDiaryGenderSelection ?????????? ????? ??????? ??? ????????
func (ch *CommandHandler) showDiaryGenderSelection(userID int64) error {
	text := "?? ???????? ??? ??? ??? ?????????????? ????????:"
	keyboard := tgbotapi.NewInlineKeyboardMarkup(
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("?? ???????", "diary_gender_male"),
			tgbotapi.NewInlineKeyboardButtonData("?? ???????", "diary_gender_female"),
		),
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("?? ?????", "main_menu"),
		),
	)
	
	msg := tgbotapi.NewMessage(userID, text)
	msg.ReplyMarkup = keyboard
	_, err := ch.bot.Send(msg)
	return err
}

// showExercisesMenu ?????????? ???? ????????? ??????????
func (ch *CommandHandler) showExercisesMenu(userID int64) error {
	if !ch.userManager.IsAdmin(userID) {
		msg := tgbotapi.NewMessage(userID, "? ??? ??????? ???????? ?????? ???????????????.")
		_, err := ch.bot.Send(msg)
		return err
	}

	response := "??? ????????? ??????????\n\n???????? ?????? ??? ????????? ??????????:"
	exercisesKeyboard := tgbotapi.NewInlineKeyboardMarkup(
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("1?? ??????", "exercise_week_1"),
			tgbotapi.NewInlineKeyboardButtonData("2?? ??????", "exercise_week_2"),
		),
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("3?? ??????", "exercise_week_3"),
			tgbotapi.NewInlineKeyboardButtonData("4?? ??????", "exercise_week_4"),
		),
	)

	msg := tgbotapi.NewMessage(userID, response)
	msg.ReplyMarkup = exercisesKeyboard
	_, err := ch.bot.Send(msg)
	return err
}

// showNotificationPanel ?????????? ?????? ??????????? (legacy style)
func (ch *CommandHandler) showNotificationPanel(userID int64) error {
	text := `?? <b>??????? ???????????</b>

???????? ??? ???????????:`

	kb := tgbotapi.NewInlineKeyboardMarkup(
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("?? ????-???????", "notify_diary"),
			tgbotapi.NewInlineKeyboardButtonData("???????????? ??????????", "notify_exercise"),
		),
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("?? ?????????", "notify_motivation"),
			tgbotapi.NewInlineKeyboardButtonData("?? ???????????????", "notify_view"),
		),
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("?? ?????", "admin_panel"),
		),
	)

	msg := tgbotapi.NewMessage(userID, text)
	msg.ParseMode = "HTML"
	msg.ReplyMarkup = kb
	_, err := ch.bot.Send(msg)
	return err
}


// showAdminPanelLegacy ?????????? ?????-?????? ??? ? legacy
func (ch *CommandHandler) showAdminPanelLegacy(userID int64) error {
	text := `?? <b>?????-?????? Lovifyy Bot</b>

?? ????????? ???????:
/setprompt <?????> - ???????? ????????? ??????
/prompt - ?????????? ??????? ??????
/setweek <??????> <????> <????????> - ????????? ???????? ??????
/adminhelp - ??? ???????

?? ???? ??? ????????? ??????:
? title - ????????? ??????
? welcome - ?????????????? ?????????
? questions - ??????? ??? ????
? tips - ?????????
? insights - ???????
? joint - ?????????? ???????
? diary - ?????????? ??? ????????
? active - ???????/??????? ?????? (true/false)

?? ????????? ??????????? ????? ??? ???? ?????????????!`

	keyboard := tgbotapi.NewInlineKeyboardMarkup(
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("?? ?????????? ??????", "prompt"),
		),
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("?? ???????? ??????", "setprompt_menu"),
		),
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("?? ?????????? ???????????", "welcome"),
		),
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("?? ???????? ???????????", "setwelcome_menu"),
		),
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("??? ????????? ??????????", "exercises_menu"),
		),
		tgbotapi.NewInlineKeyboardRow(
			tgbotapi.NewInlineKeyboardButtonData("?? ???????????", "notifications_menu"),
		),
	)

	msg := tgbotapi.NewMessage(userID, text)
	msg.ParseMode = "HTML"
	msg.ReplyMarkup = keyboard
	_, err := ch.bot.Send(msg)
	return err
}

// handleLegacyAdminCallbacks ???????????? ??????? ?????-?????? ??? ? legacy
func (ch *CommandHandler) handleLegacyAdminCallbacks(userID int64, data string) error {
	switch data {
	case "prompt":
		return ch.showCurrentPrompt(userID)
	case "setprompt_menu":
		return ch.showSetPromptMenu(userID)
	case "welcome":
		return ch.showCurrentWelcome(userID)
	case "setwelcome_menu":
		return ch.showSetWelcomeMenu(userID)
	case "exercises_menu":
		return ch.showExercisesMenu(userID)
	case "notifications_menu":
		return ch.showNotificationPanel(userID)
	}
	return nil
}

// showCurrentPrompt ?????????? ??????? ????????? ??????
func (ch *CommandHandler) showCurrentPrompt(userID int64) error {
	text := `?? ??????? ????????? ??????:

?? ??????? ???????? ???????? ? ??????????? ?? ?????????? ? ??????????? ?????? ?????? ? ??????. ???? ?????? - ???????? ????? ???????? ?? ?????????, ???????????? ???????????? ??????, ?????????? ? ?????????.

?? ??? ????????? ???????????:
/setprompt <????? ??????>`
	return ch.simpleMsg(userID, text)
}

// showSetPromptMenu ?????????? ???? ????????? ???????
func (ch *CommandHandler) showSetPromptMenu(userID int64) error {
	text := `?? ????????? ?????????? ???????

????????? ??????? ? ???????:
/setprompt <????? ??????>

?? ??????? ????????:

????????:
/setprompt ?? ??????? ????????, ??????? ???????? ????? ? ?? ??????? ??????????. ???? ????????????? ? ????? ???????? ??????.

??????????? ????????:
/setprompt ?? ??????????? ????????, ??????? ???????? ?? ????? ???????. ???? ?????????? ? ????????.`
	return ch.simpleMsg(userID, text)
}

// showCurrentWelcome ?????????? ??????? ???????????
func (ch *CommandHandler) showCurrentWelcome(userID int64) error {
	text := `?? ??????? ?????????????? ?????????:

?? ?????????????? ????????? ??? ???

??????, ???????! ???? ? ??? ??? ?????? ??? ????? ? ?????? ??????????? ? ??? ????????? ??????????? ?? ????? ??????????! ??

?? ??? ????????? ???????????:
/setwelcome <????? ???????????>`
	return ch.simpleMsg(userID, text)
}

// showSetWelcomeMenu ?????????? ???? ????????? ???????????
func (ch *CommandHandler) showSetWelcomeMenu(userID int64) error {
	text := `?? ????????? ??????????????? ?????????

????????? ??????? ? ???????:
/setwelcome <????? ???????????>

?? ??????????? ???????????? ??? ??????? /start`
	return ch.simpleMsg(userID, text)
}

// simpleMsg ? ??????? ??? ???????? ??????? ?????????
func (ch *CommandHandler) simpleMsg(userID int64, text string) error {
	msg := tgbotapi.NewMessage(userID, text)
	_, err := ch.bot.Send(msg)
	return err
}




// HandleSetWeek обрабатывает команду /setweek
func (ch *CommandHandler) HandleSetWeek(update tgbotapi.Update) error {
	userID := update.Message.From.ID
	if !ch.userManager.IsAdmin(userID) {
		msg := tgbotapi.NewMessage(userID, "? ” вас нет прав администратора")
		_, err := ch.bot.Send(msg)
		return err
	}
	
	args := strings.Fields(update.Message.Text)
	if len(args) < 4 {
		helpText := `?? <b>»спользование команды /setweek</b>

<b>‘ормат:</b>
/setweek &lt;недел€&gt; &lt;поле&gt; &lt;значение&gt;

<b>ѕримеры:</b>
/setweek 1 active true
/setweek 1 title Ќедел€ знакомства
/setweek 2 questions  акие чувства вы испытываете?

<b>ƒоступные пол€:</b>
Х active Ч активность недели (true/false)
Х title Ч заголовок недели
Х welcome Ч приветственное сообщение
Х questions Ч упражнени€/вопросы недели
Х tips Ч подсказки
Х insights Ч инсайты
Х joint Ч совместные вопросы
Х diary Ч инструкции по дневнику`

		msg := tgbotapi.NewMessage(userID, helpText)
		msg.ParseMode = "HTML"
		_, err := ch.bot.Send(msg)
		return err
	}
	
	weekStr := args[1]
	field := args[2]
	switch field {
	case "joint_questions":
		field = "joint"
	case "diary_instructions":
		field = "diary"
	case "welcome_message":
		field = "welcome"
	}
	value := strings.Join(args[3:], " ")
	
	weekNum, err := strconv.Atoi(weekStr)
	if err != nil || weekNum < 1 {
		msg := tgbotapi.NewMessage(userID, "? Ќеверный номер недели")
		_, err := ch.bot.Send(msg)
		return err
	}
	
	if err := ch.exerciseManager.SaveWeekField(weekNum, field, value); err != nil {
		msg := tgbotapi.NewMessage(userID, fmt.Sprintf("? ќшибка сохранени€: %v", err))
		_, err := ch.bot.Send(msg)
		return err
	}
	
	msg := tgbotapi.NewMessage(userID, fmt.Sprintf("? ѕоле %s дл€ недели %d успешно обновлено", field, weekNum))
	_, err = ch.bot.Send(msg)
	return err
}

// HandleUnknownCommand обрабатывает неизвестные команды
func (ch *CommandHandler) HandleUnknownCommand(update tgbotapi.Update) error {
	userID := update.Message.From.ID
	msg := tgbotapi.NewMessage(userID, "? Ќеизвестна€ команда. »спользуйте /help дл€ справки.")
	_, err := ch.bot.Send(msg)
	return err
}
